<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Antplanner - A better WebSOC for UCI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.9.1/themes/smoothness/jquery-ui.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <link rel="stylesheet" href="css/jquery.weekcalendar.css">
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/main.css">
    <!--link rel="stylesheet" href="css/websoc.css" type="text/css">
      <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-16581503-1']);
        _gaq.push(['_trackPageview']);

        (function() {
          var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
      </script-->
  </head>
  <body>
    <div id="left">
      <div id="upper">
        <div id="main-nav">
            <h1>New Antplanner</h1>
            <!--a target="_blank" href="https://github.com/gumho/antplanner2/wiki/AntPlanner-FAQ">?</a-->
        </div>
        <div id="cal-ctrl"> 
	  <button type="button" class="btn" onclick="javascript:$('#degreeworks').toggle(); this.innerText = (this.innerText == 'DegreeWorks') ? 'Calendar' : 'DegreeWorks';">DegreeWorks</button>
	  <button type="button" class="btn" onclick="javascript:print()">Print</button>
          <button type="button" id="save-btn" class="btn">Save</button>
          <button type="button" id="load-btn" class="btn">Load</button>
          <button type="button" id="clear-cal-btn" class="btn">Clear</button>
          <button type="button" id="resize-btn" class="btn">Size</button>
        </div>
      </div>
      <div id="cal">
       <div id="degreeworks" style="position:absolute; width:100%; height:100%; background-color:white; z-index:1000; display:none;">
         <div id="webauth-container">

          <!-- UCI Header Information -->
            <div id="header">&nbsp;</div>

          <!-- Title Bar that allows for custom headings for departments and organizations. Optional-->
            <div id="title-bar">
                <div id="application-title">UCInetID Secure Web Login</div>
                <div id="login-status"></div>
                <div class="clearer"><!-- --></div>
            </div>
            
            
          <div id="content-container">

            <!-- Login Box -->
            <div id="login-area" style="float:inherit; margin: 0 auto;">
              <div id="webauth_login_form_id" name="webauth_login_form">
                <ul id="login-form">
              <li>
            <label for="ucinetid">UCInetID</label>
            <input name="ucinetid" type="text" accesskey="1" tabindex="1" maxlength="64" id="ucinetid">
            <div class="example">UCInetID Example: ptanteater</div>
            <div class="clearer"><!-- --></div>
              </li>
              <li>
            <label for="password">Password</label>
            <input name="password" type="password" accesskey="2" tabindex="2" id="password">
            <br>
	    <div class="clearer"><!-- --></div>
              </li>
	      <li>
		<p class="login-error" style="color:red;"><p>
              </li>
	      <li class="button-bar">
            <span id="login_button_span"><input type="button" id="login" name="login_button" value="Login" accesskey="3" tabindex="3"></span>
            <span id="login_status_span" style="visibility: hidden;">Logging in...</span>
            <span id="login_image_span" style="visibility: hidden;"><!--img id="logging_in_img" src="images/webauth_kitt.gif" alt=". . . . ."--></span>
              </li>
          </ul>
                <div class="clearer"><!-- --></div>
              </div>
           
              <span id="forgot-password"><a href="https://activate.uci.edu">Forgot your password?</a></span>
              <p id="privacy-warning"><strong>WARNING! Protect your privacy. Logout when you are done and completely exit your browser. </strong></p>
            </div>
              <!-- Information area. Including News Items, Custom Links for Department/Organization and General UCInetID Information. -->
              <div class="clearer"><!-- --></div>

              <div id="main_bottom_edge">&nbsp;</div>

          </div>
          <!-- Footer Information. Includes Webauth and OIT Links -->
            <div id="footer">
              <p class="smalltext-footer">Powered by WebAuth, Developed by <a href="http://www.oit.uci.edu" target="_blank">OIT</a>.</p>
              <p class="smalltext-footer"><a href="http://security.uci.edu" target="_blank">Computing Security &amp; Resources</a></p>
            </div>
          </div>
            <div class="degreeworks-results" style="overflow:auto; background-color:white;position:absolute; width:100%; height:100%; top: 0; display:none;">
              <input type="button" value="Logout" id="logout" style="margin:5px; float:right; top:0;"/>
              <div id="degreeworks-response" style="display:inline;"></div>
	    </div>
       </div>
      </div>
    </div>
    <div id="right">
      <div id="websoc-search" style="width: 90%; margin: 10px auto;">
      </div>
      <div class="course-list">
        <table style="width:100%; font:initial;">
	</table>
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.9.1/jquery-ui.min.js"></script>
    <script src="js/jquery.weekcalendar.js"></script>
    <script src="js/antplanner2.js"></script>
    <script>

    function get_listings(ev) {
      var dept = document.getElementsByName("Dept")[0].value;
      var breadth = document.getElementsByName("Breadth")[0].value;
      var yearTerm = document.getElementsByName("YearTerm")[0].value;
      var courseNum = document.getElementsByName("CourseNum")[0].value;
      show_listings({
        "mode": "search",
        "Breadth": breadth,
        "Dept": dept,
        "YearTerm": yearTerm,
        "CourseNum": courseNum
      });
    }

    function showDegreeWorks(){
      $("#degreeWorks").toggle();
    }

    function show_listings(data) {
      $("#search-message")[0].innerHTML = "Loading";
      var posting = $.post("/cgi-bin/search.py", data);
      posting.done(function(data) {
        if (data.search('ERROR:') >= 0) {
          $('#search-message')[0].innerHTML = data.substr(7);
          return;
        }
        $("#search-message")[0].innerHTML = "";
        $(".course-list table")[0].innerHTML = data + $(".course-list table")[0].innerHTML;

        $(".course-list table td .toggle").click(function(ev) {
	  ev.target.src = ev.target.src.search("down-128.png") >= 0 ? "media/up-128.png" : "media/down-128.png"; 
	  var tar = ev.target.parentElement.parentElement.parentElement.children;
          for (var i = 1; i < tar.length; i++) {
            $(tar[i]).toggle()
          }
        });

        $(".course-list table td .remove").click(function(ev) {
          var tar = ev.target.parentElement.parentElement.parentElement;
          $(tar).remove();
        });
	linkRows();

      });
    }

    function get_search() {
      var posting = $.post("/cgi-bin/search.py", {
        "mode": "load"
      });
      posting.done(function(data) {
        $("#websoc-search")[0].innerHTML = data;
        $("#search")[0].onclick = get_listings;
        $("#clearSearch")[0].onclick = function(ev) { $(".course-list table tbody").remove(); };
      });
    }

        function linkRows(){
          var $listingContext = $('.course-list table');
          var $courseRow = $("tr[valign*='top']:not([bgcolor='#fff0ff'])", $listingContext);

            // FIXME: hover() deprecated
            $courseRow.hover(
              function() {
                $(this).css({'color': '#ff0000', 'cursor': 'pointer'});
              },
              function() {
                $(this).css({'color': '#000000', 'cursor': 'default'});
              }
            );

            $courseRow.on('click', function() {
              var timeString = $(this).find('td').eq(LISTING_TIME_INDEX).html();

              // Ignore if course is "TBA"
              if(timeString.indexOf('TBA') != -1) {
                alert('Course is TBA');
                return;
              }

              var courseCode = $(this).find('td').eq(LISTING_CODE_INDEX).text();

              // Ignore if course already added
              if(isCourseAdded(courseCode)) {
                alert('You have already added that course!');
                return;
              }

              var courseName = $.trim( $(this).prevAll().find(".CourseTitle:last").html().split("<font")[0].replace(/&nbsp;/g, "") );
              var courseTimes = new CourseTimeStringParser(timeString)
              var roomString = $(this).find('td').eq(LISTING_ROOM_INDEX).html();
              var rooms = parseRoomString(roomString);

              // Iterate through course times (a course may have different meeting times)
              for(var i in courseTimes) {
                var parsed = courseTimes[i];
                $('#cal').weekCalendar('scrollToHour', parsed.beginHour, true);

                if (i in rooms && rooms[i].length > 0) {
                    var room = rooms[i];
                } else {
                    // Is there a possibility that there is only one room listed for all times (in the case of multiple times)?
                    var room = "TBA";
                }

                for(var i in parsed.days) {
                  var day = parsed.days[i];

                  calEvent = {
                    id: S4(),
                    groupId: courseCode,
                    start: new Date(APP_YEAR, APP_MONTH, day, parsed.beginHour, parsed.beginMin),
                    end: new Date(APP_YEAR, APP_MONTH, day, parsed.endHour, parsed.endMin),
                    title: courseName + ' at ' + room + '<br>(' + courseCode + ')'
                  }
                  $('#cal').weekCalendar("updateEvent", calEvent);
                }
              }

              // Assign a color to the courses
              var colorPair = getRandomColorPair();
              $('.wc-cal-event').each(function(index, el) {
                var c = $(el).data().calEvent
                if( c.groupId.indexOf(courseCode) != -1 ) {
                  colorEvent(el, colorPair);
                }
              });
            });
        }

      $(document).ready(function() {
        get_search();
        $('#cal').weekCalendar({
          businessHours: {start: 6, end: 24, limitDisplay: true},
          showHeader: false,
          showColumnHeaderDate: false,
          timeslotsPerHour: 3,
          daysToShow:5,
          readonly: true,
          useShortDayNames: true,
          allowCalEventOverlap: true,
          overlapEventsSeparate: true,
          buttons: false,
          height: function($calendar){
            return $(window).height() - $('#upper').outerHeight();
          },
          draggable : function(calEvent, element) { return false; },
          resizable : function(calEvent, element) { return false; },
          eventClick : function(calEvent, element) {
            var delCode = calEvent.groupId;
            $('.wc-cal-event').each(function(index, el) {
              var c = $(el).data().calEvent
              if( c.groupId == delCode ) {
                $('#cal').weekCalendar('removeEvent', c.id);
              }
            });
          }
        });

        $('#cal').weekCalendar('gotoWeek', new Date(APP_YEAR, APP_MONTH, APP_DAY));


        $('#save-btn').on('click', function() {
          var calData  = JSON.stringify( $('#cal').weekCalendar('serializeEvents') );

          var defaultName = localStorage.username ? localStorage.username : '';
          var username = prompt('Please enter a unique username (e.g. Student ID): ', defaultName);

          // Validation
          if(username == null) {
            return;
          }

          if(username.length < 5) {
            alert('Username must be at least 5 characters.')
            return;
          }

          // Save to server
          $.ajax({
            url: "{{url_for('save_schedule')}}",
            type: 'post',
            data: {
              username: username,
              data: calData
            },
            success: function(data) {
              if(data.success) {
                alert('Schedule successfully saved!');
                localStorage.username = username;
              }
              else {
                alert('Problem saving schedule');
              }
            }
          });
        });

        $('#load-btn').on('click', function() {
          var defaultName = localStorage.username ? localStorage.username : '';
          var username = prompt('Please enter your username', defaultName);

          if(username == '') {
            return;
          }

          $.ajax({
            url: '/schedule/load',
            data: { username: username },
            success: function(data) {
              if(data.success) {
                $('#cal').weekCalendar('clear');
                $('#cal').weekCalendar("loadEvents", JSON.parse(data.data));
                groupColorize();
                alert('Schedule successfully loaded!');
              }
              else {
                alert('Problem loading schedule');
              }
            }
          });
        });

        $("#logout").on("click", function(ev){
          $(".degreeworks-results").toggle();
          $("#login-container").toggle();
	  $(".login-error").text("");
        });

        $("#login").on("click", function (ev){ 
	  $(".login-error").text("Loading");
           
          var ucinetid = $("#ucinetid").val(), password = $("#password").val();
          if (ucinetid == "" || password == ""){
	    $(".login-error").text("Must provide Ucinetid and password");
	    return;
	  }
	  data = {"ucinetid": ucinetid, "password": password, "mode": "Degreeworks"};
	  var posting = $.post("/cgi-bin/webauth.py", data);
	  posting.done(function(data) {
		if (data.startsWith("ERROR")){
		  $(".login-error").text(data);
		  return;
		}
		$(".degreeworks-results").toggle();
		$("#degreeworks-response").html(data);
		$(".ruleTable th input").click(function(ev) {
		  var children = ev.currentTarget.parentElement.parentElement.parentElement.getElementsByTagName("input");
		  for (var i = 1; i < children.length; i++) {
		    children[i].click();
		  }
	        });
		$(".ruleTable td input").click(function(ev) {
		  var a = ev.currentTarget;
		  show_listings({
		    "mode": "search",
		    "Dept": a.getAttribute("Dept"),
		    "CourseNum": a.getAttribute("CourseNum"),
		    "YearTerm": document.getElementsByName("YearTerm")[0].value
		  });
		});
	  });
        });

        $('#clear-cal-btn').on('click', function() {
          $('#cal').weekCalendar('clear');
        });

        // TODO: toggle() deprecated
        $('#resize-btn').toggle(function() {
          $(this).addClass('active');
          $('#soc').hide();
          $('#cal').animate({width: '200%'});
        }, function() {
          $('#cal').animate({width: '100%'});
          $('#soc').show();
          $(this).removeClass('active');
        });
      });
    </script>
  </body>
</html>
