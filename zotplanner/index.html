<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>A Better Antplanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.9.1/themes/smoothness/jquery-ui.css">
  <!--script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script-->
  <link rel="stylesheet" href="css/jquery.weekcalendar.css">
  <link rel="stylesheet" href="css/reset.css">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="http://www.reg.uci.edu/css/webreg.css" type="text/css" title="WebReg Styles">
</head>

<body style="overflow:hidden;">
  <div id="login-modal" style="position:absolute; top:30px; left:10px; z-index: 1200; border:2px solid; display:none;">
    <div id="webauth-container">

          <!-- UCI Header Information -->
          <div id="header">&nbsp;</div>

          <!-- Title Bar that allows for custom headings for departments and organizations. Optional-->
          <div id="title-bar">
            <div id="application-title">UCInetID Secure Web Login</div>
            <div id="login-status"></div>
            <div class="clearer">
              <!-- -->
            </div>
          </div>


          <div id="content-container">

            <!-- Login Box -->
            <div id="login-area" style="float:inherit; margin: 0 auto;">
              <div id="webauth_login_form_id" name="webauth_login_form">
                <ul id="login-form">
                  <li>
                    <label for="ucinetid">UCInetID</label>
                    <input name="ucinetid" type="text" accesskey="1" tabindex="1" maxlength="64" id="ucinetid">
                    <div class="example">UCInetID Example: ptanteater</div>
                    <div class="clearer">
                      <!-- -->
                    </div>
                  </li>
                  <li>
                    <label for="password">Password</label>
                    <input name="password" type="password" accesskey="2" tabindex="2" id="password">
                    <br>
                    <div class="clearer">
                      <!-- -->
                    </div>
                  </li>
                  <li>
                    <p class="login-error" style="color:red;">
                      <p>
                  </li>
                  <li class="button-bar">
                    <span id="login_button_span"><input type="button" id="login" name="login_button" value="Login" accesskey="3" tabindex="3">
                    </span>
                    <span id="login_status_span" style="visibility: hidden;">Logging in...</span>
                    <span id="login_image_span" style="visibility: hidden;"><!--img id="logging_in_img" src="images/webauth_kitt.gif" alt=". . . . ."--></span>
                  </li>
                </ul>
                <div class="clearer">
                  <!-- -->
                </div>
              </div>

              <span id="forgot-password"></span>
              <p id="privacy-warning"><strong>WARNING! Protect your privacy. Logout when you are done and completely exit your browser. </strong>
              </p>
            </div>
            <!-- Information area. Including News Items, Custom Links for Department/Organization and General UCInetID Information. -->
            <div class="clearer">
              <!-- -->
            </div>

            <div id="main_bottom_edge">&nbsp;</div>

          </div>
          <!-- Footer Information. Includes Webauth and OIT Links -->
          <div id="footer">
            <p class="smalltext-footer">Powered by WebAuth, Developed by <a href="http://brettjsettle.site" target="_blank">Brett S.</a>.</p>
            <p class="smalltext-footer"><a href="http://security.uci.edu" target="_blank">Computing Security &amp; Resources</a>
            </p>
          </div>
        </div>
  </div>
  <div id="left">
    <div id="upper">
      <div id="main-nav">
        <input type="button" id="toggleLogin" onclick="toggleLogin();" value="Login">
        <h1>New Antplanner</h1>
        <!--a target="_blank" href="https://github.com/gumho/antplanner2/wiki/AntPlanner-FAQ">?</a-->
      </div>
      <div id="cal-ctrl">
        <button type="button" class="btn" id="degreeworks-button" onclick="toggleDegreeWorks();">DegreeWorks</button>
        <!--button type="button" class="btn" onclick="javascript:print()">Print</button-->
        <button type="button" class="btn" id="webreg-button">WebReg</button>

        <button type="button" id="save-btn" class="btn">Save</button>
        <button type="button" id="load-btn" class="btn">Load</button>
        <button type="button" id="clear-cal-btn" class="btn">Clear</button>
        <button type="button" id="resize-btn" class="btn">Size</button>
      </div>
    </div>
    <div id="lower" style="position:relative;">
      <div id="cal">
      </div>
      <div id="degreeworks" style="position:absolute; width:100%; height:100%; background-color:white; z-index:1000; background-color:white; top: 0; display:none;">
        <iframe id="degreeworks-response" style="display:inline; width:100%; height:100%;"></iframe>
      </div>
    </div>
  </div>
  <div id="right">
    <div id="webreg" style="position:absolute; top:0; height: 100%; display:none; background:white; width: inherit; padding:10px">
      <form style="margin: 100px 0px 0px 0px;" id="registerForm">
      <table cellpadding="3" cellspacing="0" align="center" border="0" style="margin:0 auto;">
        <tbody>
          <tr>
            <td colspan="3" align="center">
              <table id="regRow" width="600" border="1" bgcolor="#ddeeff" align="center" cellpadding="5" cellspacing="0" style="border-color: #083194; white-space: nowrap;">
                <tbody>
                  <tr>
                    <td align="center" valign="middle">
                      <font size="3" color="#083194">Request</font>
                    </td>
                    <td align="center" valign="middle">
                      <font size="3" color="#083194">Course&nbsp;Code(s)</font>
                    </td>
                    <td align="center" valign="middle" bgcolor="#d5e5ff">
                      <font size="3" color="#083194">Grade&nbsp;Option</font>
                    </td>
                    <td align="center" valign="middle" bgcolor="#d5e5ff">
                      <font size="3" color="#083194">Variable&nbsp;Units</font>
                    </td>
                    <td align="center" valign="middle" bgcolor="#d5e5ff">
                      <font size="3" color="#083194">Authorization&nbsp;Code</font>
                    </td>
                  </tr>
                  <tr>
                    <td align="left" valign="middle" style="border-right: 0;">
                      <input type="radio" name="mode" value="add" id="add" checked>
                      <label for="add"><font size="3">Add</font>
                      </label>
                      <br>
                      <input type="radio" name="mode" value="change" id="change">
                      <label for="change"><font size="3">Change</font>
                      </label>
                      <br>
                      <input type="radio" name="mode" value="drop" id="drop">
                      <label for="drop"><font size="3">Drop</font>
                      </label>
                    </td>
                    <td align="center" valign="middle" style="border-left: 0;">
                      <select id="courseCodes" name="courseCode" size="5" maxlength="5" style="width:100px" multiple>
                      </select>
                    </td>
                    <td align="center" valign="middle" bgcolor="#d5e5ff">
                      <input type="text" name="gradeOption" size="1" maxlength="1">
                      <font size="2">1=Grade,&nbsp;2=P/NP</font>
                    </td>
                    <td align="center" valign="middle" bgcolor="#d5e5ff">
                      <input type="text" name="varUnits" size="2" maxlength="2">
                    </td>
                    <td align="center" valign="middle" bgcolor="#d5e5ff">
                      <input type="text" name="authCode" size="4" maxlength="4">
                    </td>
                  </tr>
                  <tr>
                    <td align="left" valign="middle" style="border-right: 0;">
                    </td>
                    <td align="center" valign="middle" style="border-left: 0;">
                    </td>
                    <td colspan="3" align="center">
                      <input type="button" value="Send Request" id="sendRequest" class="action" style="margin: 5px;">
                      <input type="button" value="Study List" id="studyList" class="action">
                    </td>
                  </tr>
                </tbody>
              </table>
            </td>
          </tr>
          <tr>
          </tr>
        </tbody>
      </table>
    </form>
    <div class="col" id="registerMessage" style="display:flex; width:85%; margin:20px auto;">
      
    </div>
    </div>
    <div id="websoc-search" style="width: 90%; margin: 10px auto;">
    </div>
    <div class="course-list" style="padding:5px">
      <table style="width:100%; font:initial;">
      </table>
    </div>
  </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.9.1/jquery-ui.min.js"></script>
  <script src="js/jquery.weekcalendar.js"></script>
  <script src="js/antplanner2.js"></script>
  <script>
    var reload = false;
    function toggleLogin(){
      if ($("#toggleLogin").val() == "Logout"){
        $("#ucinetid").val("");
        $("#password").val("");
	$('#degreeworks-response').contents().find('html').html('');
	$("#degreeworks-button").text("Calendar");
	$('#degreeworks')[0].style['display'] = 'none';
      }
      $("#toggleLogin").val("Login");
      reload = true;
      $("#login-modal").toggle();
      $("#ucinetid").focus();
    }
    
    function get_listings(ev) {
      var dept = document.getElementsByName("Dept")[0].value;
      var breadth = document.getElementsByName("Breadth")[0].value;
      var yearTerm = document.getElementsByName("YearTerm")[0].value;
      var courseNum = document.getElementsByName("CourseNum")[0].value;
      show_listings({
        "mode": "search",
        "Breadth": breadth,
        "Dept": dept,
        "YearTerm": yearTerm,
        "CourseNum": courseNum
      });
    }

    $("#webreg-button").on("click", function(ev){
      data = {"ucinetid": $("#ucinetid").val(), "password" : $("#password").val()};
      if ($("#webreg-button").text() == "WebReg" && (data["ucinetid"] == "" || data["password"] == "")){
        loginMessage("Must provide UCInetId and password");
        return;
      }
      $("#webreg").toggle();
      $("#webreg-button").text($("#webreg-button").text() == "WebSOC" ? "WebReg" : "WebSOC");
    });

    function toggleDegreeWorks() {
      $("#login-modal")[0].style["display"] = "none";
      if ($("#degreeworks-button")[0].innerText == "Calendar"){  
          $("#degreeworks").toggle();
          $("#degreeworks-button")[0].innerText = "DegreeWorks";
          return;
        }
        
        var ucinetid = $("#ucinetid").val(),
          password = $("#password").val();
        if (ucinetid == "" || password == ""){
          loginMessage("Must provide a ucinetid and password");
          return;
        }
        $("#degreeworks-button")[0].disabled=true;
        $("#degreeworks-button")[0].innerText = "Loading";
        var data = {
          "ucinetid": ucinetid,
          "password": password,
          "mode": "Degreeworks"
        };
        degreeworks(data);
        
    }

    function show_listings(data) {
      if ($("#webreg-button").text() == "WebSOC"){
        $("#webreg").toggle();
        $("#webreg-button").text($("#webreg-button").text() == "WebSOC" ? "WebReg" : "WebSOC");
      }

      $("#search-message")[0].innerHTML = "Loading";
      var posting = $.post("/cgi-bin/search.py", data);
      posting.done(function(data) {
        if (data.search("ERROR:") >= 0) {
          $("#search-message")[0].innerHTML = data.substr(7);
          return;
        }
        $("#search-message")[0].innerHTML = "";
        $(".course-list table")[0].innerHTML = data + $(".course-list table")[0].innerHTML;

        $(".course-list table td .toggle").click(function(ev) {
          ev.target.src = ev.target.src.search("down-128.png") >= 0 ? "media/up-128.png" : "media/down-128.png";
          var tar = ev.target.parentElement.parentElement.parentElement.children;
          for (var i = 1; i < tar.length; i++) {
            $(tar[i]).toggle()
          }
        });

        $(".course-list table td .remove").click(function(ev) {
          var tar = ev.target.parentElement.parentElement.parentElement;
          $(tar).remove();
        });
        linkRows();

      });
    }

    function get_search() {
      var posting = $.post("/cgi-bin/search.py", {
        "mode": "load"
      });
      posting.done(function(data) {
        $("#websoc-search")[0].innerHTML = data;
        $("#search")[0].onclick = get_listings;
        $("#clearSearch")[0].onclick = function(ev) {
          $(".course-list table tbody").remove();
        };
      });
    }

    function linkRows() {
      var $listingContext = $(".course-list table");
      var $courseRow = $("tr[valign*='top']:not([bgcolor='#fff0ff'])", $listingContext);

      // FIXME: hover() deprecated
      $courseRow.hover(
        function() {
          $(this).css({
            "color": "#ff0000",
            "cursor": "pointer"
          });
        },
        function() {
          $(this).css({
            "color": "#000000",
            "cursor": "default"
          });
        }
      );

      $courseRow.on("click", function() {
        var timeString = $(this).find("td").eq(LISTING_TIME_INDEX).html();

        // Ignore if course is "TBA"
        if (timeString.indexOf('TBA') != -1) {
          alert('Course is TBA');
          return;
        }

        var courseCode = $(this).find('td').eq(LISTING_CODE_INDEX).text();
        // Ignore if course already added
        if (isCourseAdded(courseCode)) {
          alert('You have already added that course!');
          return;
        }

        var courseName = $.trim($(this).prevAll().find(".CourseTitle:last").html().split("<font")[0].replace(/&nbsp;/g, ""));
        var courseTimes = new CourseTimeStringParser(timeString)
        var roomString = $(this).find('td').eq(LISTING_ROOM_INDEX).html();
        var rooms = parseRoomString(roomString);

        // Iterate through course times (a course may have different meeting times)
        for (var i in courseTimes) {
          var parsed = courseTimes[i];
          $('#cal').weekCalendar('scrollToHour', parsed.beginHour, true);

          if (i in rooms && rooms[i].length > 0) {
            var room = rooms[i];
          } else {
            // Is there a possibility that there is only one room listed for all times (in the case of multiple times)?
            var room = "TBA";
          }

          for (var i in parsed.days) {
            var day = parsed.days[i];

            calEvent = {
              id: S4(),
              groupId: courseCode,
              start: new Date(APP_YEAR, APP_MONTH, day, parsed.beginHour, parsed.beginMin),
              end: new Date(APP_YEAR, APP_MONTH, day, parsed.endHour, parsed.endMin),
              title: courseName + ' at ' + room + '<br>(' + courseCode + ')'
            }
            $('#cal').weekCalendar("updateEvent", calEvent);
          }
        }

        // Assign a color to the courses
        var colorPair = getRandomColorPair();
        $('.wc-cal-event').each(function(index, el) {
          var c = $(el).data().calEvent
          if (c.groupId.indexOf(courseCode) != -1) {
            colorEvent(el, colorPair);
          }
        });
      });
    }

    $("#sendRequest, #studyList").click(function(event) {
      $('.action').attr('disabled', '');
      var data = $("#registerForm").serializeArray().reduce(function(obj, item) {
        obj[item.name] = item.value;
        return obj;
      }, {});
      data["courseCodes"] = "";
      var ch = $("#courseCodes").children();
      for (var i = 0; i < ch.length; i++){
	data["courseCodes"] += ch[i].value + " ";
      }
      if (event.target.value != "Study List" &&  data["courseCodes"] == ""){
        $('.action').removeAttr('disabled');
	registerMessage("No classes listed");
	return;
      }
	
      data.ucinetid = $("#ucinetid").val();
      data.password = $("#password").val();
      if (data.password == "" || data.ucinetid == "") {
        loginMessage("Not logged in to WebReg.");
        $('.action').removeAttr('disabled');
	return;
      }
      
      data.submit = event.target.value;
      var posting = $.post("/cgi-bin/register.py", data);
      posting.done(function(data) {
        registerMessage(data);
        $('.action').attr('disabled', null);
      });
    });

    function registerMessage(message) {
      message = message || "";
      $("#registerMessage")[0].innerHTML = message;
    }


    function addRegCode(code){
      var ch = $("#courseCodes").children();
      for(var i = 0; i < ch.length; i++){
        var b = ch[i];
        if (b.value == code){
          return;
        }
      }
      var newOpt = $('<option>', {
        value: code,
        text: code
      });
      $(newOpt).on("click", function(a){
        removeRegCode(code);
      })
      $('#courseCodes').append(newOpt);
    }

    function removeRegCode(code){
      $("#courseCodes").children().each( function(a, b){
        if (b.value == code){
          $("#courseCodes")[0].removeChild(b);
        }
      });
    }

    function degreeworks(data){
        if (!reload){
          $("#degreeworks").toggle();
          $ ("#degreeworks-button")[0].innerText = 'Calendar';
         $("#degreeworks-button")[0].disabled=false;
          return;
        }
        var posting = $.post("/cgi-bin/webauth.py", data);
        posting.done(function(data) {
          $("#degreeworks-button")[0].disabled=false;
          if (data.startsWith("ERROR")) {
            loginMessage(data);

            $("#degreeworks-button")[0].innerText = 'Degreeworks';
            return;
          }
          $('#degreeworks').toggle();
          $("#degreeworks-button")[0].innerText = 'Calendar';
          
          $("#degreeworks-response").contents().find('html').html(data);
          connectDW();
          reload = false;
          $("#toggleLogin").val("Logout");
        });
      }

    function connectDW(){
        var doc = $("#degreeworks-response").contents(); 
	$('span, td.courseapplieddatadiscnum', doc).on('click', function(ev){
		var disc = this.getAttribute('disc'), num = this.getAttribute('num');
		var yearTerm = document.getElementsByName("YearTerm")[0].value;
		show_listings({
		    "mode": "search",
		    "Dept": disc,
		    "CourseNum": num,
		    "YearTerm": yearTerm
		});
		ev.stopPropagation();
	});

	$('tr.bgLight100, tr.bgLight0', doc).on('click', function(ev){
		listings = {};
		var spans = $('span', this);
		var yearTerm = document.getElementsByName("YearTerm")[0].value;
		if (spans.length == 0){
			spans = $('td.courseapplieddatadiscnum', this);
		}
		for (var i = 0; i < spans.length; i++){
			var disc = spans[i].getAttribute('disc'), num = spans[i].getAttribute('num');
			if (!listings.hasOwnProperty(disc))
				listings[disc] = num;
			else
				listings[disc] += ", " + num;
		}
		for(var disc in listings){
			show_listings({
			    "mode": "search",
			    "Dept": disc,
			    "CourseNum": listings[disc],
			    "YearTerm": yearTerm
			});
		}
	});
    }

    $(document).ready(function() {
      get_search();
      $('#cal').weekCalendar({
        businessHours: {
          start: 6,
          end: 24,
          limitDisplay: true
        },
        showHeader: false,
        showColumnHeaderDate: false,
        timeslotsPerHour: 3,
        daysToShow: 5,
        readonly: true,
        useShortDayNames: true,
        allowCalEventOverlap: true,
        overlapEventsSeparate: true,
        buttons: false,
        height: function($calendar) {
          return $(window).height() - $('#upper').outerHeight();
        },
        draggable: function(calEvent, element) {
          return false;
        },
        resizable: function(calEvent, element) {
          return false;
        },
        eventClick: function(calEvent, element) {
          if ($("#webreg")[0].style["display"] == "none"){
            if ($("#degreeworks-button").text() == "Calendar"){
              toggleDegreeWorks();
            }
            var delCode = calEvent.groupId;
            removeRegCode(delCode);
            $('.wc-cal-event').each(function(index, el) {
              var c = $(el).data().calEvent
              if (c.groupId == delCode) {
                $('#cal').weekCalendar('removeEvent', c.id);
              }
            });
          }else{
            addRegCode(calEvent.groupId);
          }
        }
      });

      $('#cal').weekCalendar('gotoWeek', new Date(APP_YEAR, APP_MONTH, APP_DAY));


      $('#save-btn').on('click', function() {
        var calData = JSON.stringify($('#cal').weekCalendar('serializeEvents'));
	console.log(calData);
        //var defaultName = localStorage.username ? localStorage.username : '';
        var username = prompt('Please enter a unique username (e.g. Student ID): ', "");

        // Validation
        if (username == null) {
	  return;
        }

        if (username.length < 5) {
          alert('Username must be at least 5 characters.')
          return;
        }

        // Save to server
        $.ajax({
          url: "/cgi-bin/schedule.py",
          type: 'post',
          data: {
            username: username,
            data: calData
          },
          success: function(data) {
            if (data.search("ERROR") == -1) {
              alert('Schedule successfully saved!');
              localStorage.username = username;
            } else {
              alert('Problem saving schedule. ' + data);
            }
          }
        });
      });

      $('#load-btn').on('click', function() {
        var defaultName = localStorage.username ? localStorage.username : '';
        var username = prompt("Please enter your username", defaultName);

        if (username == "") {
          return;
        }

        $.ajax({
          url: "/cgi-bin/schedule.py",
          data: {
            username: username
          },
          success: function(data) {
            if (data.search("ERROR") == -1) {
              $("#cal").weekCalendar("clear");
              $("#cal").weekCalendar("loadEvents", JSON.parse(data));
              groupColorize();
              alert("Schedule successfully loaded!");
            } else {
              alert("Problem loading schedule. " + data);
            }
          }
        });
      });

      $("#clear-cal-btn").on("click", function() {
        $("#cal").weekCalendar("clear");
      });

      // TODO: toggle() deprecated
      $("#resize-btn").toggle(function() {
        $(this).addClass("active");
        $("#soc").hide();
        $("#cal").animate({
          width: "200%"
        });
      }, function() {
        $("#cal").animate({
          width: "100%"
        });
        $("#soc").show();
        $(this).removeClass("active");
      });
    });

    $("#login").on("click", function(){
      $("#login_status_span")[0].style["visibility"] = "";
      loginMessage("");
      var ucinetid = $("#ucinetid").val(), password = $("#password").val();
      if (ucinetid == "" || password == ""){
	loginMessage("Login with your UCInetID and password");
        $("#login_status_span")[0].style["visibility"] = "hidden";
        return;
      }
      data = {"ucinetid": ucinetid, "password": password, mode: "Login"}
      var posting = $.post("/cgi-bin/webauth.py", data);
      posting.done(function(data) {
        $("#login_status_span")[0].style["visibility"] = "hidden";
	if (data.search("ERROR") == -1){
	  toggleLogin();
	  $("#toggleLogin").val("Logout");
	}else{
	  loginMessage(data);
	}
      });
    });

    $("#password").keydown(function(ev){
      if (ev.keyCode == 13){
        $("#login").click();
      }
    });

    function loginMessage(message){
        if ($("#login-modal")[0].style["display"] == "none"){
          toggleLogin();
        }
        $(".login-error").text(message);
      }
  </script>
</body>

</html>
