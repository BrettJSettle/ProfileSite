<html>
<link rel="stylesheet" href="http://www.reg.uci.edu/css/webreg.css" type="text/css" title="WebReg Styles">
<link href="css/main.css" rel="stylesheet">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

<body>
  <div id="content">
  <div class="profile" style="overflow:hidden;">
    <div id="login" class="col">
      <ul id="login-form">
        <li>
          <label for="ucinetid">UCInetID</label>
          <input name="ucinetid" type="text" accesskey="1" tabindex="1" maxlength="64" id="usrid">
          <div class="example">UCInetID Example: ptanteater</div>
        </li>
        <li>
          <label for="password">Password</label>
          <input name="password" type="password" accesskey="2" tabindex="2" id="pwd">
        </li>
      </ul>
      <div style="display:none;" style="float:left; padding-left: 10px;">
        <p>Auth
          <input id="ucinetid_auth" type="text" name="ucinetid_auth" disabled/>
        </p>
        <p>Call #
          <input id="call" type="text" name="call" disabled/>
        </p>
      </div>
      <input class="action" type="button" value="Re-Authenticate" id="login-button">
      <input type="button" class="action" value="Logout" style="float:right;" id="logout-button">
    </div>
    <div class="col" id="authMessage" style="border: none; color:red; margin:auto; overflow:hidden; max-height:110px;">
      <h1 style="color: white; text-align:center; font-size: 30px;"><span style="font-size:40px">ZotPlanner</span> the one stop course planner and signup site for UCI.</h1>
    </div>
  </div>
  <div class="profile" style="height: 70%;">
    <div class="col" style="width:30%;" id="degreeworks">
      <div id="degreeworks-response">
      </div>
    </div>
    <div class="col" style="width:70%;" id="websoc">
      <div id="websoc-search">
      </div>
      <table id="websoc-results">
      </table>
    </div>
  </div>
  <div class="profile">
    <form style="margin: 0px;" id="registerForm">
      <table cellpadding="3" cellspacing="0" align="center" border="0">
        <tbody>
          <tr>
            <td colspan="3" align="center">
              <table width="600" border="1" bgcolor="#ddeeff" align="center" cellpadding="5" cellspacing="0" style="border-color: #083194; white-space: nowrap;">
                <tbody>
                  <tr>
                    <td align="center" valign="middle">
                      <font size="3" color="#083194">Request</font>
                    </td>
                    <td align="center" valign="middle">
                      <font size="3" color="#083194">Course&nbsp;Code</font>
                    </td>
                    <td align="center" valign="middle" bgcolor="#d5e5ff">
                      <font size="3" color="#083194">Grade&nbsp;Option</font>
                    </td>
                    <td align="center" valign="middle" bgcolor="#d5e5ff">
                      <font size="3" color="#083194">Variable&nbsp;Units</font>
                    </td>
                    <td align="center" valign="middle" bgcolor="#d5e5ff">
                      <font size="3" color="#083194">Authorization&nbsp;Code</font>
                    </td>
                  </tr>
                  <tr>
                    <td align="left" valign="middle" style="border-right: 0;">
                      <input type="radio" name="mode" value="add" id="add" checked>
                      <label for="add"><font size="3">Add</font>
                      </label>
                      <br>
                      <input type="radio" name="mode" value="change" id="change">
                      <label for="change"><font size="3">Change</font>
                      </label>
                    </td>
                    <td align="center" valign="middle" style="border-left: 0;">
                      <input type="text" name="courseCode" size="5" maxlength="5">
                    </td>
                    <td align="center" valign="middle" bgcolor="#d5e5ff">
                      <input type="text" name="gradeOption" size="1" maxlength="1">
                      <font size="2">1=Grade,&nbsp;2=P/NP</font>
                    </td>
                    <td align="center" valign="middle" bgcolor="#d5e5ff">
                      <input type="text" name="varUnits" size="2" maxlength="2">
                    </td>
                    <td align="center" valign="middle" bgcolor="#d5e5ff">
                      <input type="text" name="authCode" size="4" maxlength="4">
                    </td>
                  </tr>
                  <tr>
                    <td align="left" valign="middle" style="border-right: 0;">
                      <input type="radio" name="mode" value="drop" id="drop">
                      <label for="drop"><font size="3">Drop</font>
                      </label>
                      <br>
                      <input type="radio" name="mode" value="listOpen" id="listOpen">
                      <label for="listOpen"><font size="3">List&nbsp;Open&nbsp;Sections</font>
                      </label>
                    </td>
                    <td align="center" valign="middle" style="border-left: 0;">
                    </td>
                    <td colspan="3" align="center">
                      <input type="button" value="Send Request" id="sendRequest" class="action">
                      <input type="button" value="Study List" id="studyList" class="action">
                    </td>
                  </tr>
                </tbody>
              </table>
            </td>
          </tr>
        </tbody>
      </table>
    </form>
    <div class="col" id="registerMessage" style="width:100%;">

    </div>
  </div>
  </div>
  <script>
   $("#pwd").keyup(function(event){
     if(event.keyCode == 13){
       $("#login-button").click();
     }
   }); 

   function get_listings(ev) {
      var dept = document.getElementsByName("Dept")[0].value;
      var breadth = document.getElementsByName("Breadth")[0].value;
      var yearTerm = document.getElementsByName("YearTerm")[0].value;
      var courseNum = document.getElementsByName("CourseNum")[0].value;
      show_listings({
        "mode": "search",
        "Breadth": breadth,
        "Dept": dept,
        "YearTerm": yearTerm,
        "CourseNum": courseNum
      });
    }

    function show_listings(data) {
      $("#search-message")[0].innerHTML = "Loading";
      var posting = $.post("/cgi-bin/search.py", data);
      posting.done(function(data) {
        if (data.search('ERROR:') >= 0) {
          $('#search-message')[0].innerHTML = data.substr(7);
          return;
        }
        $("#search-message")[0].innerHTML = "";
        $("#websoc-results")[0].innerHTML = data + $("#websoc-results")[0].innerHTML;

        $("#websoc-results td .toggle").click(function(ev) {
          var tar = ev.target.parentElement.parentElement.parentElement.children;
          for (var i = 1; i < tar.length; i++) {
            $(tar[i]).toggle()
          }
        });

        $("#websoc-results td .remove").click(function(ev) {
          var tar = ev.target.parentElement.parentElement.parentElement;
          $(tar).remove();
        });

      });
    }

    function listingClicked(code) {
      document.getElementsByName("courseCode")[0].value = code;
    }

    function get_search() {
      var posting = $.post("/cgi-bin/search.py", {
        "mode": "load"
      });
      posting.done(function(data) {
        $("#websoc-search")[0].innerHTML = data;
        $("#search")[0].onclick = get_listings;
        $("#clearSearch")[0].onclick = function(ev) { $("#websoc-results tbody").remove(); };
      });
    }
    get_search();

    function registerMessage(message) {
      message = message || "";
      $("#registerMessage")[0].innerHTML = message;
    }

    function authMessage(message) {
      message = message || "";
      $("#authMessage")[0].innerHTML = message;
    }
    
    $("#logout-button").click(function(ev) {
      var auth = $("#ucinetid_auth").val();
      if (auth == undefined || auth.length < 60) {
        authMessage("You are not logged in. Log in with your UCINetID and Password.");
        return;
      }
      var ucinetid = $("#usrid").val();
      if (ucinetid == "") {
        authMessage("Please enter your UCINetID");
        return;
      }
      var data = {
        "ucinetid": ucinetid,
        "ucinetid_auth": auth,
        "call": $("#call").val(),
        "mode": "Logout"
      };

      var posting = $.post("/cgi-bin/webauth.py", data);
      posting.done(function(data) {
        $("#degreeworks-response").children().remove();
        $("#ucinetid_auth").val("");
        $("#call").val("");
	$("#registerMessage").children().remove();
        authMessage(data);
      });
    });

    function degreeworks(data){
      var posting = $.post("/cgi-bin/webauth.py", data);
      posting.done(function(data) {
        $("#degreeworks-response").html(data);
        $(".ruleTable th input").click(function(ev) {
          var children = ev.currentTarget.parentElement.parentElement.parentElement.getElementsByTagName("input");
          for (var i = 1; i < children.length; i++) {
            children[i].click();
          }
        });
        $(".ruleTable td input").click(function(ev) {
          var a = ev.currentTarget;
          show_listings({
            "mode": "search",
            "Dept": a.getAttribute("Dept"),
            "CourseNum": a.getAttribute("CourseNum"),
            "YearTerm": document.getElementsByName("YearTerm")[0].value
          });
        });
        $('.action').attr('disabled', null);
        authMessage("");
      });
    }

    $("#sendRequest, #studyList").click(function(event) {
      $('.action').attr('disabled', '');
      var data = $("#registerForm").serializeArray().reduce(function(obj, item) {
        obj[item.name] = item.value;
        return obj;
      }, {});
      data.ucinetid = $("#usrid").val();
      data.ucinetid_auth = $("#ucinetid_auth").val();
      data.call = $("#call").val();
      
      if (isNaN(data.call) || data.ucinetid_auth.length < 64 || data.ucinetid == "") {
        registerMessage("Not logged in to WebReg.");
        return;
      }
      
      registerMessage("Loading");
      data.submit = event.target.value;
      var posting = $.post("/cgi-bin/register.py", data);
      posting.done(function(data) {
        registerMessage(data);
        $('.action').attr('disabled', null);
      });
    });

    $("#login-button").click(function(event) {
      $('.action').attr('disabled', '');
      authMessage("Logging in...");
      
      var auth = $("#ucinetid_auth").val();
      if (auth.length > 60){
	$("#logout").click();
      }
      auth = "";
      
      var ucinetid = $("#usrid").val();
      var password = $("#pwd").val();
      if (ucinetid == "" || password == "") {
        authMessage("Please enter your UCINetID and password");
        return;
      }
      var data = {
        "ucinetid": ucinetid,
        "password": password,
        "ucinetid_auth": auth,
        "call": $("#call").val(),
        "mode": "Re-Authenticate"
      };

      var posting = $.post("/cgi-bin/webauth.py", data);
      posting.done(function(login_data) {
        if (login_data.search("ERROR") >= 0) {
          authMessage(login_data);
          return;
        }
        var vals = login_data.split(" ");
        var auth = vals[0];
        var callNum = vals[1];
        if (auth.length != 65) {
          authMessage("Login Authorization failed");
          return;
        }
        $("#ucinetid_auth").val(auth);
        if (isNaN(callNum)) {
          $("#call").val("");
          //authMessage("Failed to get call number. Cannot register for classes");
        } else {
          $("#call").val(callNum);
          authMessage("Successfully logged in");
        }
	data["mode"] = "Degreeworks";
	data["ucinetid_auth"] = $("#ucinetid_auth").val();
	degreeworks(data);
      });
    });
  </script>
</body>

</html>
